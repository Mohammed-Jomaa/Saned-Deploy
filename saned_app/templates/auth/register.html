{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>إنشاء حساب - ساند</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'CSS/style.css' %}" />

  <style>
    body {
      background: linear-gradient(to bottom right, #ffffff, #A8D5C3);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .register-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 8%;
    }

    .register-card {
      flex: 1;
      background-color: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      max-width: 500px;
    }

    .form-label {
      margin-bottom: 6px;
      font-weight: 500;
    }

    .input-group {
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .input-group-text {
      background-color: #e9ecef;
      border: none;
      padding: 10px 14px;
    }

    .form-control {
      border: none;
      border-radius: 0;
      padding: 10px 14px;
      box-shadow: none;
    }

    .form-control:focus {
      outline: none;
      box-shadow: none;
    }

    .btn {
      border-radius: 10px;
      padding: 10px;
      font-size: 1.1rem;
    }

    .text-danger.small {
      font-size: 0.8rem;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .register-wrapper {
        flex-direction: column;
        text-align: center;
      }

      .register-card {
        max-width: 100%;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="register-wrapper">
    <div class="register-card">
      <h2 class="text-center mb-4"><i class="fas fa-user-plus me-2"></i>إنشاء حساب جديد</h2>

      <div id="register-success" class="alert alert-success text-center d-none"></div>

      <form id="register-form">
        {% csrf_token %}
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-user"></i></span>
          <input type="text" name="registerFirstName" class="form-control" placeholder="الاسم الأول" required />
        </div>
        <div class="text-danger small" id="error-registerFirstName"></div>

        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-user"></i></span>
          <input type="text" name="registerLastName" class="form-control" placeholder="الاسم الأخير" required />
        </div>
        <div class="text-danger small" id="error-registerLastName"></div>

        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-envelope"></i></span>
          <input type="email" name="registerEmail" class="form-control" placeholder="البريد الإلكتروني" required />
        </div>
        <div class="text-danger small" id="error-registerEmail"></div>

        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
          <select name="registerRegion" class="form-control" required>
                        <option value="" disabled selected>اختر المدينة</option>
                        <option value="القدس">القدس</option>
                        <option value="رام الله">رام الله</option>
                        <option value="البيرة">البيرة</option>
                        <option value="نابلس">نابلس</option>
                        <option value="الخليل">الخليل</option>
                        <option value="بيت لحم">بيت لحم</option>
                        <option value="قلقيلية">قلقيلية</option>
                        <option value="طولكرم">طولكرم</option>
                        <option value="جنين">جنين</option>
                        <option value="سلفيت">سلفيت</option>
                        <option value="أريحا">أريحا</option>
                        <option value="طوباس">طوباس</option>
                    </select>
        </div>
        <div class="text-danger small" id="error-registerRegion"></div>

        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
          <select name="role" id="role" class="form-control" onchange="toggleNGODocument()" required>
            <option value="">اختر نوع الحساب</option>
            <option value="beneficiary">محتاج</option>
            <option value="donor">متبرع</option>
            <option value="ngo">جمعية</option>
          </select>
        </div>
        <div class="text-danger small" id="error-role"></div>

        <div id="ngo-document-group" class="input-group mb-2" style="display: none;">
          <span class="input-group-text"><i class="fas fa-file-upload"></i></span>
          <input type="file" name="licenseDocument" class="form-control" />
        </div>

        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-lock"></i></span>
          <input type="password" name="registerPassword" class="form-control" placeholder="كلمة المرور" required />
        </div>
        <div class="text-danger small" id="error-registerPassword"></div>

        <div class="input-group mb-2">
          <span class="input-group-text"><i class="fas fa-lock"></i></span>
          <input type="password" name="registerRepeatPassword" class="form-control" placeholder="تأكيد كلمة المرور" required />
        </div>
        <div class="text-danger small" id="error-registerRepeatPassword"></div>

        <button type="submit" class="btn btn-success w-100">إنشاء حساب</button>

        <p class="mt-3 text-center">
          لديك حساب بالفعل؟ <a href="{% url 'login' %}" class="fw-bold" style="color: #004D40;">سجّل الدخول</a>
        </p>
      </form>
    </div>
  </div>

  <script>
    function toggleNGODocument() {
      const role = document.getElementById("role").value;
      document.getElementById("ngo-document-group").style.display = role === "ngo" ? "flex" : "none";
    }

    document.getElementById("register-form").onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      document.querySelectorAll(".text-danger.small").forEach(el => el.innerHTML = "");
      document.getElementById("register-success").classList.add("d-none");

      const response = await fetch("{% url 'create_user' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: formData
      });

      const res = await response.json();

      if (res.success) {
        this.reset();
        this.style.display = "none";
        const box = document.getElementById("register-success");
        box.innerHTML = `تم إنشاء الحساب بنجاح! <br><a href="{% url 'login' %}" class="btn btn-outline-dark mt-3">تسجيل الدخول الآن</a>`;
        box.classList.remove("d-none");
      } else {
        const errors = res.errors;
        for (const key in errors) {
          const errorDiv = document.getElementById(`error-${key}`);
          if (errorDiv) {
            errorDiv.innerHTML = errors[key];
          }
        }
      }
    };
  </script>

  <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
</body>

</html>
